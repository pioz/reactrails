# Reactrails

Reactrails is a Rails engine that makes it easy to integrate **React** into
a **Rails** application using modern **esbuild**, with optional **server-side
rendering (SSR)** powered by Node JS.

It gives you:

- A simple **view helper** to render React components from your Rails views.
- Automatic **client-side render or hydration** using a small loader script.
- Optional **SSR support** so you can render components on the server for better SEO and faster first paint.

## Installation

Add the gem to your `Gemfile`:

```ruby
gem "reactrails", github: "pioz/reactrails"
```

and then run:

```sh
bundle install
```

Reactrails provides a Rails generator to setup your current application:

```sh
bin/rails generate reactrails:install
```

This generator will:

1. Add the `javascript_include_tag "reactrails"` in your `application.html.erb` layout.
2. Add the file `app/javascript/components/index.js` for a convenient setup.
3. Add `import "./components"` in `app/javascript/application.js`.
4. Add the `yarn build:ssr` script to compile the SSR bundle in the `package.json`.
5. Add the `ssr: yarn build:ssr --watch` command in your `Procfile.dev`.
6. Add the file `config/initializers/reactrails.rb` to configure the gem.

## Usage

### Register your React components

Reactrails must be initialized by calling the global `initReactRails` function
provided by the JavaScript file included with
`javascript_include_tag "reactrails"`. This function takes four parameters:

- The React object
- The ReactDOMClient object
- Optionally, the ReactDOMServer object (if you use SSR; otherwise pass `null`)
- A registry object containing all the components you need to mount in your Rails application.

Example: `app/javascript/components/index.js`:

```js
import React from 'react'
import ReactDOMClient from 'react-dom/client'
import ReactDOMServer from 'react-dom/server'

import Hello from './Hello'
import Counter from './Counter'

initReactRails(React, ReactDOMClient, ReactDOMServer, {
  Hello,
  Counter
})
```

Compile this file with your own esbuild setup so that it is available to the
browser (for example via `app/assets/builds` or whatever output directory you
use).

This file is also built for SSR at the default path
`app/assets/builds/ssr/index.js`, but you can change this location in the
`config/initializers/reactrails.rb` configuration file. If you do so, make sure
to update the output path accordingly in the `build:ssr` script within your
`package.json`.

### Render components in Rails views

Reactrails provides a single helper method:

```ruby
render_component(component_name, props = {}, options = {})
```

- `component_name` – the key you used in ReactRailsComponents (string).
- `props` – a Ruby hash that will be converted to JSON and passed to the React component.
- `options` – extra options; currently:
  - `prerender` – when true, the component is also rendered on the server (SSR).
  - `tag` – the root tag to use (default `<div>`).
  - `html_options` – the html attributes to apply to the root tag.

**Client-side only rendering**

```ruby
<%= render_component "Hello", { name: "Enrico" } %>
```

This will:

1. Render a `<div>` with `data-react-component`and`data-react-props`.
2. Let reactrails find that node, instantiate the React component, and mount it via `createRoot`.

**Server-side rendering (SSR) + hydration**

To enable SSR for a component:

```ruby
<%= render_component "Hello", { name: "Enrico" }, prerender: true %>
```

With `prerender: true`:

1. Reactrails renders the component to an HTML string using Node JS on the server.
2. That HTML is placed inside the container `<div>`.
3. On the client side, reactrails hydrates the existing markup using `hydrateRoot`.

### Configuration

On the configuration file `config/initializers/reactrails.rb` is possible
configure the gem. The available options are:

- `ssr_init_reactrails_bundle_path`: move SSR bundle file with `initReactRails` call to a custom path
- `ssr_preload_code`: optional JavaScript code used to customize the server-side rendering context

## How works internally

### Client JavaScript loader

The client loader provided by the gem works as follows:

1. Listens for `turbo:load` events.
2. Scans the document for elements with `data-react-component`.
3. Reads the component name and JSON props from `data-react-component` and `data-react-props`.
4. Finds the corresponding React component registered with `initReactRails` function.
5. Creates a React element with the props.
6. Uses:
   - `hydrateRoot` if the element already has children (SSR case),
   - otherwise `createRoot` and `root.render`.

### SSR loader

On the Ruby side, Reactrails uses `Reactrails::ReactRenderer`:

- It reads:
  - Your app's SSR bundle: `app/assets/builds/ssr/index.js` (generated by `yarn build:ssr`)
  - The gem's server-side reactrails bundle: `reactrails.js`
- It concatenates them and compiles them with Node JS.
- It finally calls:

```
context.call("renderComponent", component_name, props_json)
```

## Build vendor assets

You can rebuild the gem's internal JavaScript bundle with:

```sh
bundle install
yarn install
yarn build
```

This runs the scripts defined in `package.json` and regenerates the file
`app/assets/builds/reactrails.js`.

## Questions or problems?

If you have any issues please add an [issue on
GitHub](https://github.com/pioz/reactrails/issues) or fork the project and send a
pull request.

## Copyright

Copyright (c) 2025 [Enrico Pilotto (@pioz)](https://github.com/pioz). See
[LICENSE](https://github.com/pioz/reactrails/blob/master//MIT-LICENSE) for details.
