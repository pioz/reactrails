# Reactrails

Reactrails is a Rails engine that makes it easy to integrate **React**
into a **Rails** application using **esbuild**, with optional **server-side
rendering (SSR)** powered by ExecJS.

It gives you:

- A simple **view helper** to render React components from your Rails views.
- Automatic **client-side render or hydration** using a small loader script.
- Optional **SSR support** so you can render components on the server for better SEO and faster first paint.

## Installation

Add the gem to your `Gemfile`:

```ruby
gem "reactrails"
```

and then run:

```sh
bundle install
```

Reactrails provides a Rails generator to setup your current application:

```sh
bin/rails generate reactrails:install
```

This generator will:

1. Add the `javascript_include_tag "react_loader"` in your `application.html.erb` layout.
2. Add the `yarn build:ssr` script to compile the SSR bundle in the `package.json`.
3. Add the `ssr: yarn build:ssr --watch` command in your `Procfile.dev`.
4. Add the file `app/javascript/components/index.js` for a convenient setup.

## Usage

### Register your React components

Reactrails expects a global registry called `ReactRailsComponents` to be present in the JavaScript runtime.
You are free to structure your files as you prefer; a common pattern is to have a dedicated registry file.

Example: `app/javascript/components/index.js`:

```js
import Hello from './Hello'
import Counter from './Counter'

globalThis.ReactRailsComponents = {
  Hello,
  Counter
}
```

Compile this file with your own esbuild setup so that it is available to the
browser (for example via `app/assets/builds` or whatever output directory you
use).

The important part is that, when ReactRails `react_loader.js` runs in the browser,
`globalThis.ReactRailsComponents` already contains your components.

### Render components in Rails views

Reactrails provides a single helper method:

```ruby
render_component(component_name, props = {}, options = {})
```

- `component_name` – the key you used in ReactRailsComponents (string).
- `props` – a Ruby hash that will be converted to JSON and passed to the React component.
- `options` – extra options; currently:
  - `prerender` – when true, the component is also rendered on the server (SSR).

**Client-side only rendering**

```ruby
<%= render_component "Hello", { name: "Enrico" } %>
```

This will:

1. Render a `<div>` with `data-react-component`and`data-react-props`.
2. Let `react_loader.js` find that node, instantiate the React component, and mount it via `createRoot`.

**Server-side rendering (SSR) + hydration**

To enable SSR for a component:

```ruby
<%= render_component "Hello", { name: "Enrico" }, prerender: true %>
```

With `prerender: true`:

1. Reactrails renders the component to an HTML string using ExecJS on the server.
2. That HTML is placed inside the container `<div>`.
3. On the client side, `react_loader.js` hydrates the existing markup using `hydrateRoot`.

## How works internally

### Client JavaScript loader

The client loader provided by the gem (`react_loader.js`) works as follows:

1. Listens for `turbo:load` events.
2. Scans the document for elements with `data-react-component`.
3. Reads the component name and JSON props from `data-react-component` and `data-react-props`.
4. Finds the corresponding React component in `globalThis.ReactRailsComponents`.
5. Creates a React element with the props.
6. Uses:
   - `hydrateRoot` if the element already has children (SSR case),
   - otherwise `createRoot` and `root.render`.

### SSR loader

On the Ruby side, Reactrails uses `Reactrails::ReactRenderer`:

- It reads:
  - Your app's SSR bundle: `app/assets/builds/ssr/index.js` (generated by `yarn build:ssr`)
  - The gem's server-side helper bundle: `react_server_rendering.js`
- It concatenates them and compiles them with ExecJS.
- It finally calls:

```
context.call("renderComponent", component_name, props_json)
```

You generally do not need to touch this; just make sure that:

- `globalThis.ReactRailsComponents` is defined in your SSR bundle.
- `renderComponent` is defined (provided by the gem's bundled `react_server_rendering.js`).

## Build vendor assets

You can rebuild the gem's internal JavaScript bundles with:

```sh
bundle install
yarn install
yarn build
```

This runs the `build:client` and `build:server` scripts defined in
`package.json` and regenerates the files under `vendor/` dir of the gem.

## Questions or problems?

If you have any issues please add an [issue on
GitHub](https://github.com/pioz/reactrails/issues) or fork the project and send a
pull request.

## Copyright

Copyright (c) 2025 [Enrico Pilotto (@pioz)](https://github.com/pioz). See
[LICENSE](https://github.com/pioz/reactrails/blob/master//MIT-LICENSE) for details.
